<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.choikang.chukahaeyo.card.CardMapper">
    <insert id="insertUrl" parameterType="com.choikang.chukahaeyo.card.model.CardVO">
        INSERT INTO short_urls(cardUrl, cardQR) VALUES (#{cardUrl}, #{cardQR})
    </insert>

    <insert id="insertCardInCart" parameterType="com.choikang.chukahaeyo.card.model.CardVO">
        INSERT INTO Card
            (cardName, cardIsPublic, cardIsPayed, cardStartDate, cardEndDate,
            cardDesign, templateThumbnail, categoryID, memberID)
        VALUES
            (#{cardName}, #{cardIsPublic}, false, #{cardStartDate}, #{cardEndDate},
            #{cardDesign}, #{templateThumbnail}, #{categoryID}, #{memberID})
    </insert>

    <select id="getPersonalCardList" parameterType="int" resultType="com.choikang.chukahaeyo.card.model.CardVO">
        SELECT * FROM Card WHERE memberID = #{memberId}
    </select>

    <select id="getPublicCardList" resultType="com.choikang.chukahaeyo.card.model.CardVO">
        SELECT * FROM Card WHERE (cardIsPublic = TRUE) AND (cardIsPayed = TRUE)
    </select>

    <select id="getTop3CardList" resultType="com.choikang.chukahaeyo.card.model.CardVO">
        SELECT *
        FROM (
                 SELECT *,
                        ROW_NUMBER() OVER (PARTITION BY categoryId ORDER BY cardLikeCnt DESC, ABS(DATEDIFF(cardStartDate, NOW())) ASC) as rn
                 FROM Card
                 WHERE cardIsPublic = TRUE
             ) ranked
        WHERE rn = 1;
--         SELECT * FROM Card WHERE cardIsPublic = TRUE ORDER BY cardLikeCnt DESC LIMIT 3
    </select>

    <delete id="deleteCard" parameterType="int">
        DELETE FROM Card WHERE cardID = #{cardId}
    </delete>

</mapper>